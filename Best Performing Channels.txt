WITH viewership_clean AS (
    SELECT
        v.userid,
        v.channel2,
        v.recorddate2,
        u.province,
        TO_DATE(SPLIT_PART(v.recorddate2::STRING, ' ', 1), 'YYYY/MM/DD') AS record_dt
    FROM "BRIGHTLEARNTV"."PUBLIC"."VIEWERSHIP" v
    LEFT JOIN "BRIGHTLEARNTV"."PUBLIC"."USERPROFILES" u
        ON v.userid = u.userid
    WHERE v.recorddate2 IS NOT NULL
      AND v.userid IS NOT NULL
      AND v.channel2 IS NOT NULL
      AND u.province IS NOT NULL
),

-- Count unique viewers per province and channel
province_channel_viewers AS (
    SELECT
        province,
        channel2,
        COUNT(DISTINCT userid) AS unique_viewers
    FROM viewership_clean
    GROUP BY province, channel2
)

-- Rank channels within each province
SELECT
    province,
    channel2,
    unique_viewers,
    RANK() OVER (PARTITION BY province ORDER BY unique_viewers DESC) AS rank_in_province
FROM province_channel_viewers
ORDER BY province, rank_in_province;
