---Viewers by Month and Channel

WITH viewership_clean AS (
    SELECT
        v.userid,
        v.channel2,
        v.recorddate2,
        TO_DATE(SPLIT_PART(v.recorddate2::STRING, ' ', 1), 'YYYY/MM/DD') AS record_dt
    FROM "BRIGHTLEARNTV"."PUBLIC"."VIEWERSHIP" v
    WHERE v.recorddate2 IS NOT NULL
      AND v.userid IS NOT NULL
      AND v.channel2 IS NOT NULL
),

viewership_time AS (
    SELECT
        vc.userid,
        vc.channel2,
        vc.record_dt,
        TO_CHAR(vc.record_dt, 'YYYY') AS year_value,
        TO_CHAR(vc.record_dt, 'MM') AS month_value,
        TRIM(TO_CHAR(vc.record_dt, 'Month')) AS month_name
    FROM viewership_clean vc
)

SELECT
    year_value AS year,
    month_name,
    month_value AS month_number,
    channel2,
    COUNT(DISTINCT userid) AS unique_viewers
FROM viewership_time
GROUP BY year_value, month_name, month_value, channel2
ORDER BY year_value, month_value, channel2;

---Monthly Viewers by Category 

WITH channel_category_map AS (
    SELECT 'Africa Magic' AS channel2, 'Entertainment' AS channel_category UNION ALL
    SELECT 'Channel O', 'Entertainment' UNION ALL
    SELECT 'E! Entertainment', 'Entertainment' UNION ALL
    SELECT 'M-Net', 'Entertainment' UNION ALL
    SELECT 'Vuzu', 'Entertainment' UNION ALL
    SELECT 'Boomerang', 'Kids' UNION ALL
    SELECT 'Cartoon Network', 'Kids' UNION ALL
    SELECT 'Break in transmission', 'Other' UNION ALL
    SELECT 'CNN', 'Other' UNION ALL
    SELECT 'DStv Events 1', 'Other' UNION ALL
    SELECT 'kykNET', 'Other' UNION ALL
    SELECT 'MK', 'Other' UNION ALL
    SELECT 'SawSee', 'Other' UNION ALL
    SELECT 'Supersport Live Events', 'Other' UNION ALL
    SELECT 'Trace TV', 'Other' UNION ALL
    SELECT 'ICC Cricket World Cup 2011', 'Sports' UNION ALL
    SELECT 'Live on SuperSport', 'Sports' UNION ALL
    SELECT 'SuperSport Blitz', 'Sports' UNION ALL
    SELECT 'Wimbledon', 'Sports'
),

-- Clean viewership data
viewership_clean AS (
    SELECT
        v.userid,
        v.channel2,
        TO_DATE(SPLIT_PART(v.recorddate2::STRING, ' ', 1), 'YYYY/MM/DD') AS record_dt
    FROM "BRIGHTLEARNTV"."PUBLIC"."VIEWERSHIP" v
    WHERE v.recorddate2 IS NOT NULL
      AND v.userid IS NOT NULL
      AND v.channel2 IS NOT NULL
),

-- Add month, year, and category
viewership_time AS (
    SELECT
        vc.userid,
        vc.channel2,
        TRIM(TO_CHAR(vc.record_dt, 'Month')) AS month_name,
        TO_CHAR(vc.record_dt, 'MM') AS month_number,
        TO_CHAR(vc.record_dt, 'YYYY') AS year_value,
        cm.channel_category
    FROM viewership_clean vc
    LEFT JOIN channel_category_map cm
        ON vc.channel2 = cm.channel2
)

-- Monthly unique viewers by category
SELECT
    year_value AS year,
    month_name,
    month_number,
    channel_category,
    COUNT(DISTINCT userid) AS unique_viewers
FROM viewership_time
GROUP BY year_value, month_name, month_number, channel_category
ORDER BY year_value, month_number, channel_category;
